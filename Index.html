<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditoria dos Correios</title>
  <style>
    /* ======= Tema ICS / Total (apenas formatação visual) ======= */
    :root{
      --brand-red:#C6322A;
      --brand-red-2:#D94C43;
      --bg:#F7F4F2;
      --panel:#FFFFFF;
      --text:#202020;
      --muted:#555555;
      --link:#1E6BD6;
      --border:#E2E2E2;
      --warn:#F4C542;
      --ok:#2E7D32;
      --maxw:1250px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Arial, Helvetica, sans-serif}
    a{color:var(--link)}

    .container{max-width:var(--maxw);margin:0 auto;padding:12px}

    /* Header */
    header{background:var(--brand-red);color:#fff;border-bottom:2px solid var(--brand-red-2);border-radius:6px;padding:10px 14px}
    .header-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px}
    .logo-left{justify-self:start;font-weight:700;letter-spacing:.06em;white-space:nowrap}
    .title-wrap{justify-self:center;text-align:center}
    .title-wrap h1{margin:0;font-weight:700;letter-spacing:.18em;font-size:18px}
    .title-wrap .date{margin-top:2px;font-size:12px;color:#fff;opacity:.9;letter-spacing:.02em}
    .logo-right{justify-self:end;display:flex;align-items:center;gap:6px}
    .logo-right img{display:block;height:36px;width:auto}

    .tabs{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .tab-btn{background:transparent;border:none;color:#fff;padding:6px 8px;border-radius:0;cursor:pointer;font-weight:600}
    .tab-btn:hover,.tab-btn.active{text-decoration:underline}

    /* Busca global no topo */
    .search{margin-left:auto;display:flex;gap:6px;align-items:center}
    .search input{background:#fff;border:1px solid var(--border);border-radius:4px;padding:8px 10px;min-width:260px;color:var(--text)}

    /* Botões genéricos */
    .btn{background:#fff;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:4px;cursor:pointer}
    .btn.primary{border-color:var(--brand-red);color:var(--brand-red)}
    .btn.primary:hover{background:#fff5f4}
    .btn.success{border-color:#2E7D32;color:#2E7D32}
    .btn.warn{border-color:var(--warn);color:#A0760B}
    .btn.danger{border-color:#8B0000;color:#8B0000}

    /* Painéis / Cards */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px;margin-top:14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px}

    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}

    /* Inputs */
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{background:#fff;color:var(--text);border:1px solid #C0C0C0;border-radius:4px;padding:8px 10px}
    input:focus, select:focus, textarea:focus{outline:2px solid rgba(198,50,42,.15);border-color:var(--brand-red)}
    textarea{min-height:120px}

    /* Tabelas */
    table{width:100%;border-collapse:collapse}
    th,td{padding:9px 8px;border-bottom:1px solid var(--border)}
    th{background:#FAFAFA;color:#333;position:sticky;top:0;border-bottom:2px solid var(--brand-red-2);z-index:2}
    tbody tr:nth-child(odd){background:#FBFBFB}

    .muted{color:var(--muted)}
    .kpi{font-size:22px;font-weight:700}

    /* Badges discretas */
    .badge{display:inline-block;padding:2px 8px;border-radius:16px;font-size:12px;font-weight:600;background:#fff}
    .badge.ok{border:1px solid var(--ok);color:var(--ok)}
    .badge.err{border:1px solid var(--brand-red);color:var(--brand-red)}
    .badge.dup,.badge.miss{border:1px solid var(--warn);color:#A0760B}

    .hidden{display:none}
    .footer{margin-top:24px;color:var(--muted);font-size:12px}

    /* Ajustes responsivos */
    @media(max-width:900px){
      .header-row{grid-template-columns:1fr 1fr}
      .logo-left{order:1}
      .logo-right{order:3}
      .title-wrap{order:2;grid-column:1/3}
      .search input{min-width:160px}
    }
  </style>
  <!-- Biblioteca Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- ====== CABEÇALHO NOVO (visual) ====== -->
    <header>
      <div class="header-row">
        <div class="logo-left">GRIS – CWB</div>
        <div class="title-wrap">
          <h1>AUDITORIA DOS CORREIOS</h1>
          <div class="date" id="currentDate">--/--/----</div>
        </div>
        <div class="logo-right">
          <img id="total-express-logo.png" alt="Total Express" title="Total Express" />
          <button class="btn small" id="btnSetLogo" title="Alterar logo (opcional)">Trocar logo</button>
          <input id="fileLogo" type="file" accept="image/*" class="hidden" />
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="cadastro">Cadastro</button>
        <button class="tab-btn" data-tab="auditoria">Auditoria</button>
        <button class="tab-btn" data-tab="divergencias">Divergências</button>
        <button class="tab-btn" data-tab="relatorio">Relatório</button>
        <button class="tab-btn" data-tab="config">Configurações</button>
        <div class="search">
          <input id="globalSearch" placeholder="Buscar código/descrição (Ctrl+K)" />
          <button class="btn" id="btnLimparBusca">Limpar</button>
        </div>
      </div>
    </header>

    <!-- ====== CONTEÚDO FUNCIONAL / LÓGICA ORIGINAL (v3) ====== -->

    <!-- CADASTRO -->
    <section id="cadastro" class="panel">
      <div class="grid grid-2">
        <div class="card">
          <h3>Inserir códigos esperados</h3>
          <p class="help">Ao importar do Excel, o <strong>código vem da coluna F</strong> (Código do Objeto ECT) e a <strong>descrição da coluna E</strong>. Qtd esperada = 1.</p>
          <label for="txtCadastro">Códigos / Descrição / Qtd</label>
          <textarea id="txtCadastro" placeholder="código[TAB]descrição[TAB]qtd"></textarea>
          <div class="row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn primary" id="btnImportar">Importar</button>
            <label class="btn">Importar do Excel <input id="fileCadastro" type="file" accept=".xlsx,.xls,.csv" class="hidden"></label>
            <button class="btn" id="btnExportarCadastro">Exportar cadastro (.csv)</button>
            <button class="btn" id="btnExportarCadastroX">Exportar cadastro (.xlsx)</button>
            <button class="btn danger" id="btnLimparCadastro">Limpar cadastro</button>
          </div>
        </div>
        <div class="card">
          <h3>Cadastro atual</h3>
          <div style="overflow:auto;max-height:420px">
            <table id="tblCadastro">
              <thead class="sticky"><tr><th>Código</th><th>Descrição</th><th class="right">Qtd Esperada</th><th class="right">Qtd Coletada</th><th>Status</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- AUDITORIA -->
    <section id="auditoria" class="panel hidden">
      <div class="grid grid-2">
        <div class="card">
          <h3>Leitura (scanner)</h3>
          <label for="scanInput">Posicione o cursor e bip o código</label>
          <input id="scanInput" placeholder="Aponte o leitor aqui" autocomplete="off" spellcheck="false" />
          <div class="row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn success" id="btnRegistrar">Registrar (Enter)</button>
            <button class="btn warn" id="btnDesfazer">Desfazer última</button>
            <button class="btn" id="btnExportarColetas">Exportar coletas (.csv)</button>
            <button class="btn" id="btnExportarColetasX">Exportar coletas (.xlsx)</button>
            <label class="btn">Importar coletas do Excel <input id="fileColetas" type="file" accept=".xlsx,.xls,.csv" class="hidden"></label>
            <button class="btn danger" id="btnLimparColetas">Zerar coletas</button>
          </div>
          <p class="help">Se o leitor enviar uma string longa contendo S10 (ex.: <code>AB883831875BR</code>) <strong>no meio</strong>, a extração automática capta apenas o S10.</p>
          <div class="card" style="margin-top:8px">
            <div class="grid grid-3">
              <div><div class="muted">Total Coletados</div><div class="kpi" id="kColetados">0</div></div>
              <div><div class="muted">Códigos Incorretos</div><div class="kpi" id="kIncorretos">0</div></div>
              <div><div class="muted">Duplicidades</div><div class="kpi" id="kDuplicados">0</div></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Coletas</h3>
          <div style="overflow:auto;max-height:420px">
            <table id="tblColetas">
              <thead class="sticky"><tr><th>#</th><th>Código (processado)</th><th>Data/Hora</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- DIVERGÊNCIAS -->
    <section id="divergencias" class="panel hidden">
      <div class="grid grid-3">
        <div class="card">
          <h3>Faltantes</h3>
          <div style="overflow:auto;max-height:320px">
            <table id="tblFaltantes"><thead class="sticky"><tr><th>Código</th><th>Descrição</th><th class="right">Qtd Esp.</th><th class="right">Qtd Col.</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>Incorretos</h3>
          <div style="overflow:auto;max-height:320px">
            <table id="tblIncorretos"><thead class="sticky"><tr><th>Código</th><th>Ocorrências</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>Duplicados</h3>
          <div style="overflow:auto;max-height:320px">
            <table id="tblDuplicados"><thead class="sticky"><tr><th>Código</th><th>Ocorrências</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnExportarDivergencias">Exportar divergências (.csv)</button>
        <button class="btn" id="btnExportarDivergenciasX">Exportar divergências (.xlsx)</button>
      </div>
    </section>

    <!-- RELATÓRIO -->
    <section id="relatorio" class="panel hidden">
      <div class="grid grid-3">
        <div class="card"><div class="muted">Total Esperados</div><div class="kpi" id="kEsperados">0</div></div>
        <div class="card"><div class="muted">Itens com Coleta</div><div class="kpi" id="kComColeta">0</div></div>
        <div class="card"><div class="muted">Itens Faltantes</div><div class="kpi" id="kFaltantes">0</div></div>
      </div>
      <div class="footer">Dados salvos automaticamente no navegador (localStorage). Para importar/exportar Excel (.xlsx), é necessário acesso ao CDN da biblioteca.</div>
    </section>

    <!-- CONFIGURAÇÕES -->
    <section id="config" class="panel hidden">
      <div class="grid grid-2">
        <div class="card">
          <h3>Validação de código</h3>
          <div class="grid grid-3">
            <div><label>Mín. caracteres</label><input id="minLen" type="number" min="0" value="0"/></div>
            <div><label>Máx. caracteres</label><input id="maxLen" type="number" min="0" value="0"/></div>
            <div><label>Regex opcional</label><input id="regex" placeholder="^\\d{13}$ (ex: EAN-13)"/></div>
          </div>
          <div style="margin-top:8px">
            <label><input type="checkbox" id="chkExtractECT"/> Extrair automaticamente <strong>código ECT (S10)</strong> de strings longas (ex.: pega <code>AB883831875BR</code> de dentro do texto bipado)</label><br/>
            <label class="small"><input type="checkbox" id="chkRestrictBR"/> Restringir extração a códigos que terminam com <strong>BR</strong> (ex.: <code>..\d{9}BR</code>)</label>
          </div>
          <div class="row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn primary" id="btnSalvarCfg">Salvar</button>
            <button class="btn" id="btnLimparTudo">Limpar TUDO</button>
          </div>
          <p class="help">Deixe 0 para ignorar min/máx. A extração S10 procura o primeiro padrão <code>[A-Z]{2}\d{9}[A-Z]{2}</code> (ou <code>BR</code> no final, se marcado).</p>
        </div>
        <div class="card">
          <h3>Modo de leitura</h3>
          <label><input type="checkbox" id="chkGuiado"/> Modo guiado por cadastro (incrementa quantidade do item ao bipar)</label>
          <p class="help">No modo guiado, se o código existir no cadastro, incrementa a <strong>Qtd Coletada</strong> dele; se não existir, conta como incorreto.</p>
        </div>
      </div>
    </section>

    <div class="footer">Este arquivo aplica apenas alterações de <strong>formatação</strong> e mantém 100% das <strong>funções</strong> da versão v3.</div>
  </div>

<script>
(function(){
  const hasXLSX = typeof XLSX !== 'undefined';

  // ===== Header: data do dia e logo dinâmico (apresentação) =====
  (function headerInit(){
    const elDate = document.getElementById('currentDate');
    try{ elDate.textContent = new Date().toLocaleDateString('pt-BR'); }catch(e){ elDate.textContent='--/--/----'; }
    const img = document.getElementById('logoTotal');
    const btnLogo = document.getElementById('btnSetLogo');
    const file = document.getElementById('fileLogo');
    try{ const stored = localStorage.getItem('aud_header_logo_dataurl'); if(stored){ img.src = stored; } }catch(e){}
    btnLogo.addEventListener('click', ()=> file.click());
    file.addEventListener('change', ()=>{ const f = file.files && file.files[0]; if(!f) return; const rd = new FileReader(); rd.onload=()=>{ img.src = rd.result; try{ localStorage.setItem('aud_header_logo_dataurl', rd.result); }catch(e){} }; rd.readAsDataURL(f); });
  })();

  // ===== Estado & Storage =====
  const store = {
    load(){
      try{
        return {
          expected: JSON.parse(localStorage.getItem('aud_expected')||'[]'),
          scans: JSON.parse(localStorage.getItem('aud_scans')||'[]'),
          cfg: JSON.parse(localStorage.getItem('aud_cfg')||'{}'),
          search: localStorage.getItem('aud_search')||''
        };
      }catch(e){return {expected:[],scans:[],cfg:{},search:''}}
    },
    saveExpected(list){ localStorage.setItem('aud_expected', JSON.stringify(list)); },
    saveScans(list){ localStorage.setItem('aud_scans', JSON.stringify(list)); },
    saveCfg(cfg){ localStorage.setItem('aud_cfg', JSON.stringify(cfg)); },
    saveSearch(q){ localStorage.setItem('aud_search', q||''); }
  };

  let {expected, scans, cfg, search} = store.load();
  cfg = Object.assign({ minLen:0, maxLen:0, regex:'', guiado:false, extractECT:true, restrictBR:true }, cfg);

  // ===== Utilidades =====
  const $  = (q)=>document.querySelector(q);
  const $$ = (q)=>document.querySelectorAll(q);
  const nowISO = ()=> new Date().toISOString();
  const normalize = s => (s||'').trim();
  const includesI = (text, q)=> (text||'').toString().toLowerCase().includes((q||'').toString().toLowerCase());

  // Tabs visuais
  $$('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $$('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      $$('.panel').forEach(p=>p.classList.add('hidden'));
      document.getElementById(btn.dataset.tab)?.classList.remove('hidden');
      if(btn.dataset.tab==='auditoria') setTimeout(()=>$('#scanInput')?.focus(),50);
    });
  });

  // Busca global
  const searchField = $('#globalSearch');
  searchField.value = search||'';
  searchField.addEventListener('input', ()=>{ search = searchField.value; store.saveSearch(search); render(); });
  $('#btnLimparBusca').addEventListener('click', ()=>{ search=''; searchField.value=''; store.saveSearch(''); render(); });
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchField.focus(); } });

  // Parse/validação
  const parseLines = (text)=>{
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    return lines.map(line=>{
      const parts = line.split(/\t|;|,/);
      const code = normalize(parts[0]);
      const desc = normalize(parts[1]||'');
      const qty  = parseInt(parts[2]||'1',10);
      return {code, desc, qtyExpected: isFinite(qty)?Math.max(1,qty):1};
    }).filter(x=>x.code);
  };

  const validateCode = (code)=>{
    if(!code) return {ok:false, reason:'vazio'};
    if(cfg.minLen>0 && code.length<cfg.minLen) return {ok:false, reason:'curto'};
    if(cfg.maxLen>0 && code.length>cfg.maxLen) return {ok:false, reason:'longo'};
    if(cfg.regex){ try{ const re = new RegExp(cfg.regex); if(!re.test(code)) return {ok:false, reason:'regex'}; } catch(e){} }
    return {ok:true};
  };

  const expectedMap = ()=>{ const m = new Map(); expected.forEach(it=> m.set(it.code, it)); return m; };
  const scanCounts = ()=>{ const m = new Map(); scans.forEach(s=> m.set(s.code, (m.get(s.code)||0)+1)); return m; };
  function recomputeCollectedOnExpected(){ const counts = scanCounts(); expected.forEach(it=> it.qtyCollected = counts.get(it.code)||0); }

  function metrics(){
    const mExp = expectedMap(); const counts = scanCounts();
    let incorretos=0, dups=0; const seen = new Map();
    for(const s of scans){ const known = mExp.has(s.code); if(!known) incorretos++; const c=(seen.get(s.code)||0)+1; seen.set(s.code,c); if(c>1) dups++; }
    const esperados = expected.length; const comColeta = expected.filter(it=> (counts.get(it.code)||0) > 0).length; const faltantes = esperados - comColeta;
    return { incorretos, dups, esperados, comColeta, faltantes, coletados: scans.length };
  }

  function render(){
    recomputeCollectedOnExpected();
    renderCadastro(); renderColetas(); renderDivergencias(); renderKpis();
  }

  function renderCadastro(){
    const tbody = $('#tblCadastro tbody'); tbody.innerHTML='';
    const list = search? expected.filter(it=> includesI(it.code,search) || includesI(it.desc,search)) : expected;
    for(const it of list){
      const tr = document.createElement('tr');
      const status = (it.qtyCollected||0) >= (it.qtyExpected||1) ? '<span class="badge ok">OK</span>' : '<span class="badge miss">FALTA</span>';
      tr.innerHTML = `
        <td>${escapeHtml(it.code)}</td>
        <td>${escapeHtml(it.desc||'')}</td>
        <td class="right">${it.qtyExpected||1}</td>
        <td class="right">${it.qtyCollected||0}</td>
        <td>${status}</td>
        <td class="right"><button class="btn small danger" data-del="${escapeHtml(it.code)}">Excluir</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const code = btn.getAttribute('data-del');
        const idx = expected.findIndex(x=>x.code===code);
        if(idx>=0){ expected.splice(idx,1); store.saveExpected(expected); render(); }
      });
    });
  }

  function renderColetas(){
    const tbody = $('#tblColetas tbody'); tbody.innerHTML='';
    const mExp = expectedMap(); const seen = new Map();
    (search? scans.filter(s=> includesI(s.code,search)) : scans).forEach((s, i)=>{
      const num = i+1; const known = mExp.has(s.code); const c=(seen.get(s.code)||0)+1; seen.set(s.code,c); const isDup = c>1;
      let badge = known ? '<span class="badge ok">OK</span>' : '<span class="badge err">CÓDIGO INCORRETO</span>';
      if(isDup) badge += ' <span class="badge dup">DUPLICADO</span>';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${num}</td><td>${escapeHtml(s.code)}</td><td>${new Date(s.ts).toLocaleString()}</td><td>${badge}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderDivergencias(){
    const counts = scanCounts();
    // Faltantes
    const tF = $('#tblFaltantes tbody'); tF.innerHTML='';
    expected.filter(it=> (counts.get(it.code)||0) < (it.qtyExpected||1)).forEach(it=>{
      if(search && !(includesI(it.code,search) || includesI(it.desc,search))) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(it.code)}</td><td>${escapeHtml(it.desc||'')}</td><td class="right">${it.qtyExpected||1}</td><td class="right">${it.qtyCollected||0}</td>`;
      tF.appendChild(tr);
    });
    // Incorretos
    const tI = $('#tblIncorretos tbody'); tI.innerHTML='';
    const mExp = expectedMap(); const inc = {};
    scans.forEach(s=>{ if(!mExp.has(s.code)) inc[s.code]=(inc[s.code]||0)+1; });
    Object.entries(inc).forEach(([code,qty])=>{
      if(search && !includesI(code,search)) return;
      const tr = document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(code)}</td><td>${qty}</td>`; tI.appendChild(tr);
    });
    // Duplicados
    const tD = $('#tblDuplicados tbody'); tD.innerHTML='';
    const dup = {}; const seen = {};
    scans.forEach(s=>{ seen[s.code]=(seen[s.code]||0)+1; if(seen[s.code]>1) dup[s.code]=(dup[s.code]||0)+1; });
    Object.entries(dup).forEach(([code,extra])=>{
      if(search && !includesI(code,search)) return;
      const tr = document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(code)}</td><td>${extra}</td>`; tD.appendChild(tr);
    });
  }

  function renderKpis(){
    const m = metrics();
    $('#kColetados').textContent = m.coletados;
    $('#kIncorretos').textContent = m.incorretos;
    $('#kDuplicados').textContent = m.dups;
    $('#kEsperados').textContent = m.esperados;
    $('#kComColeta').textContent = m.comColeta;
    $('#kFaltantes').textContent = m.faltantes;
  }

  // ===== Cadastro: importar/CSV/Excel =====
  $('#btnImportar').addEventListener('click', ()=>{
    const items = parseLines($('#txtCadastro').value);
    if(!items.length) return alert('Nada para importar.');
    const codes = new Set(expected.map(x=>x.code));
    items.forEach(it=>{ if(!codes.has(it.code)) { expected.push({code:it.code, desc:it.desc, qtyExpected:it.qtyExpected, qtyCollected:0}); codes.add(it.code);} });
    store.saveExpected(expected); $('#txtCadastro').value=''; render();
  });

  $('#fileCadastro').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return; const rows = await readSpreadsheet(file); if(!rows || !rows.length) return alert('Nenhuma linha encontrada.');
    const codes = new Set(expected.map(x=>x.code));
    rows.forEach((r)=>{
      const E = r[4]; const F = r[5];
      const code = normalize((F||'').toString()); const desc = normalize((E||'').toString());
      if(!code) return; const headerLike = ['codigo do objeto ect','código do objeto ect','codigo','código'];
      if(headerLike.includes(code.toLowerCase())) return;
      if(!codes.has(code)) { expected.push({code, desc, qtyExpected:1, qtyCollected:0}); codes.add(code);} 
    });
    store.saveExpected(expected); e.target.value=''; render();
  });

  $('#btnExportarCadastro').addEventListener('click', ()=>{
    const rows = [['codigo','descricao','qtd_esperada','qtd_coletada']].concat(expected.map(it=>[it.code, it.desc||'', it.qtyExpected||1, it.qtyCollected||0]));
    downloadCSV('cadastro.csv', rows);
  });
  $('#btnExportarCadastroX').addEventListener('click', ()=>{
    const rows = [['codigo','descricao','qtd_esperada','qtd_coletada']].concat(expected.map(it=>[it.code, it.desc||'', it.qtyExpected||1, it.qtyCollected||0]));
    downloadXLSX('cadastro.xlsx', 'Cadastro', rows);
  });
  $('#btnLimparCadastro').addEventListener('click', ()=>{
    if(confirm('Tem certeza que deseja apagar todo o cadastro?')){ expected=[]; store.saveExpected(expected); render(); }
  });

  // ===== Coletas =====
  const scanField = $('#scanInput');
  function extractECT(text){ const s = String(text||'').toUpperCase(); const re = cfg.restrictBR ? /[A-Z]{2}\d{9}BR/ : /[A-Z]{2}\d{9}[A-Z]{2}/; const m = s.match(re); return m? m[0] : null; }
  function addScan(raw){
    let code = normalize(raw); if(!code) return; if(cfg.extractECT){ const ect = extractECT(code); if(ect) code = ect; }
    const v = validateCode(code); if(!v.ok){ alert('Código inválido: '+(v.reason||'')); return; }
    if(cfg.guiado){ const idx = expected.findIndex(x=>x.code===code); if(idx>=0){ expected[idx].qtyCollected = (expected[idx].qtyCollected||0)+1; store.saveExpected(expected); }
                   else { scans.push({code, ts: nowISO()}); store.saveScans(scans); } }
    else { scans.push({code, ts: nowISO()}); store.saveScans(scans); }
    scanField.value=''; render();
  }
  $('#btnRegistrar').addEventListener('click', ()=> addScan(scanField.value));
  scanField.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addScan(scanField.value); } });
  $('#btnDesfazer').addEventListener('click', ()=>{ if(scans.length){ scans.pop(); store.saveScans(scans); render(); } });
  $('#btnExportarColetas').addEventListener('click', ()=>{ const rows = [['ordem','codigo','timestamp']].concat(scans.map((s,i)=>[i+1, s.code, s.ts])); downloadCSV('coletas.csv', rows); });
  $('#btnExportarColetasX').addEventListener('click', ()=>{ const rows = [['ordem','codigo','timestamp']].concat(scans.map((s,i)=>[i+1, s.code, s.ts])); downloadXLSX('coletas.xlsx', 'Coletas', rows); });
  $('#fileColetas').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return; const rows = await readSpreadsheet(file); if(!rows || rows.length<=1) return alert('Nenhuma linha para importar.');
    const header = rows[0].map(h=>String(h).toLowerCase()); const idxCodigo = header.indexOf('codigo'); const idxTs = header.indexOf('timestamp'); const dataRows = (idxCodigo>=0? rows.slice(1): rows);
    dataRows.forEach((r)=>{ const raw = normalize(idxCodigo>=0? r[idxCodigo]: r[0]); if(!raw) return; let code = raw; if(cfg.extractECT){ const ect = extractECT(code); if(ect) code = ect; } const ts = idxTs>=0? String(r[idxTs]): nowISO(); if(code) scans.push({code, ts}); });
    store.saveScans(scans); e.target.value=''; render();
  });
  $('#btnLimparColetas').addEventListener('click', ()=>{ if(confirm('Tem certeza que deseja zerar as coletas?')){ scans=[]; store.saveScans(scans); render(); } });

  // ===== Divergências =====
  $('#btnExportarDivergencias').addEventListener('click', ()=>{
    const {faltantesRows, incorretosRows, duplicadosRows} = buildDivergenciasRows();
    const sections = [ ['FALTANTES','codigo','descricao','qtd_esperada','qtd_coletada'], ...faltantesRows, [''], ['INCORRETOS','codigo','ocorrencias'], ...incorretosRows, [''], ['DUPLICADOS','codigo','ocorrencias_extras'], ...duplicadosRows ];
    downloadCSV('divergencias.csv', sections);
  });
  $('#btnExportarDivergenciasX').addEventListener('click', ()=>{
    const {faltantesRows, incorretosRows, duplicadosRows} = buildDivergenciasRows();
    const sheets = { 'Faltantes': [['codigo','descricao','qtd_esperada','qtd_coletada'], ...faltantesRows], 'Incorretos': [['codigo','ocorrencias'], ...incorretosRows], 'Duplicados': [['codigo','ocorrencias_extras'], ...duplicadosRows] };
    downloadXLSXMulti('divergencias.xlsx', sheets);
  });
  function buildDivergenciasRows(){
    const counts = scanCounts();
    const faltantesRows = expected.filter(it=> (counts.get(it.code)||0) < (it.qtyExpected||1)).map(it=>[it.code, it.desc||'', it.qtyExpected||1, it.qtyCollected||0]);
    const mExp = expectedMap(); const inc = {}; scans.forEach(s=>{ if(!mExp.has(s.code)) inc[s.code]=(inc[s.code]||0)+1; }); const incorretosRows = Object.entries(inc).map(([c,q])=>[c,q]);
    const dup = {}; const seen={}; scans.forEach(s=>{ seen[s.code]=(seen[s.code]||0)+1; if(seen[s.code]>1) dup[s.code]=(dup[s.code]||0)+1; }); const duplicadosRows = Object.entries(dup).map(([c,q])=>[c,q]);
    return { faltantesRows, incorretosRows, duplicadosRows };
  }

  // ===== Helpers CSV/XLSX/Read =====
  function downloadCSV(filename, rows){ const csv = rows.map(r=> r.map(cell=>{ const s = String(cell==null?'':cell).replaceAll('"','""'); return /[";,\n]/.test(s)? '"'+s+'"' : s; }).join(';')).join('\n'); const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }
  function downloadXLSX(filename, sheetName, rows){ if(!hasXLSX){ alert('Biblioteca XLSX não carregou. Verifique sua internet.'); return; } const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, sheetName); XLSX.writeFile(wb, filename); }
  function downloadXLSXMulti(filename, sheets){ if(!hasXLSX){ alert('Biblioteca XLSX não carregou. Verifique sua internet.'); return; } const wb = XLSX.utils.book_new(); for(const [name, rows] of Object.entries(sheets)){ XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), name.substring(0,31)); } XLSX.writeFile(wb, filename); }
  async function readSpreadsheet(file){ if(!hasXLSX){ if(file.type.includes('csv') || /\.csv$/i.test(file.name)){ const text = await file.text(); return text.split(/\r?\n/).filter(Boolean).map(l=>l.split(/[;\t,]/)); } alert('Para importar Excel (.xlsx/.xls) é necessário internet para carregar a biblioteca.'); return []; } const data = new Uint8Array(await file.arrayBuffer()); const wb = XLSX.read(data, {type:'array'}); const sheet = wb.Sheets[wb.SheetNames[0]]; return XLSX.utils.sheet_to_json(sheet, {header:1, defval:''}); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // Init
  render(); setTimeout(()=>$('#scanInput')?.focus(), 200);
})();
</script>
</body>

</html>

